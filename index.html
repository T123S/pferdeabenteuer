<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pferdehof Abenteuer</title>
    
    <!-- PWA Verkn√ºpfungen -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üê¥</text></svg>">
    <meta name="theme-color" content="#7BC043">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #2c3e50;
            font-family: 'Fredoka', sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        #gameCanvas {
            display: block;
            margin: 0 auto;
            outline: none; /* Entfernt den Fokus-Rahmen */
        }

        /* --- UI Layer --- */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            color: #fff;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            font-size: 18px;
            z-index: 10;
        }

        /* Oben Links: Stats & Energie */
        .hud-left {
            position: absolute; top: 10px; left: 10px;
            display: flex; flex-direction: column; gap: 8px;
        }

        .hud-row { display: flex; align-items: center; gap: 10px; }
        
        .hud-item {
            background: rgba(0,0,0,0.5); padding: 8px 15px; border-radius: 25px;
            display: inline-flex; align-items: center; gap: 8px;
            backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.2);
        }

        /* Energie Balken */
        #stamina-container {
            width: 150px; height: 10px; background: rgba(0,0,0,0.5);
            border-radius: 10px; overflow: hidden; border: 1px solid rgba(255,255,255,0.3);
            margin-top: 5px;
        }
        #stamina-bar {
            width: 100%; height: 100%; background: #f1c40f; transition: width 0.1s;
        }

        /* Oben Rechts: Buttons */
        .hud-right {
            position: absolute; top: 10px; right: 10px;
            display: flex; flex-direction: column; gap: 10px; align-items: flex-end;
            pointer-events: auto;
        }

        /* Oben Mitte: Quest */
        #quest-box {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95); padding: 10px 20px;
            border-radius: 15px; border-left: 5px solid #FFD700; color: #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-size: 18px; max-width: 300px;
            pointer-events: none; display: none; text-shadow: none; text-align: center;
        }
        
        /* Context Hints */
        .context-hint {
            position: absolute; bottom: 150px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: #fff; padding: 10px 20px;
            border-radius: 20px; display: none; font-size: 20px;
            animation: pulse 1s infinite; pointer-events: none; white-space: nowrap;
        }
        @keyframes pulse { 0% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.1); } 100% { transform: translateX(-50%) scale(1); } }

        #sleep-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: black; opacity: 0; pointer-events: none; transition: opacity 1s;
            display: flex; justify-content: center; align-items: center;
            color: white; font-size: 40px; z-index: 200;
        }

        /* Buttons */
        button {
            pointer-events: auto; border: none; border-radius: 50px;
            font-family: 'Fredoka', sans-serif; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        button:active { transform: translateY(4px); box-shadow: none; }

        .icon-btn {
            width: 45px; height: 45px; font-size: 24px;
            display: flex; justify-content: center; align-items: center; color: white;
        }
        .btn-blue { background: #3498db; }
        .btn-purple { background: #9b59b6; }
        .btn-orange { background: #e67e22; }
        .btn-green { background: #2ecc71; }
        .btn-teal { background: #1abc9c; }
        
        #drop-btn { background: #e74c3c; color: white; padding: 8px 15px; display: none; font-size: 16px; }

        /* Training Context Buttons */
        #training-actions {
            position: absolute; bottom: 120px; right: 20px;
            display: none; flex-direction: column; gap: 10px; pointer-events: auto;
        }
        .train-btn {
            background: #f1c40f; color: #333; padding: 10px 20px; font-size: 16px; text-align: right;
            border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* Mobile Action Buttons */
        #mobile-actions {
            position: absolute; bottom: 30px; right: 30px;
            display: flex; gap: 20px; pointer-events: auto;
        }
        .action-circle {
            width: 70px; height: 70px; border-radius: 50%;
            background: rgba(255,255,255,0.3); border: 2px solid white;
            color: white; font-size: 30px; display: flex; justify-content: center; align-items: center;
        }
        .action-circle:active { background: rgba(255,255,255,0.6); }

        /* Screens & Modals */
        #level-screen, #shop-modal, #customize-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center;
            color: white; z-index: 100; text-align: center; flex-direction: column;
        }
        #level-screen { display: flex; }

        .modal-content {
            background: #fff; color: #333; padding: 20px; border-radius: 20px;
            max-width: 90%; width: 400px; max-height: 80%; overflow-y: auto;
            text-shadow: none; position: relative;
        }
        .modal-close {
            position: absolute; top: 10px; right: 15px; background: #e74c3c;
            color: white; width: 30px; height: 30px; line-height: 30px; border-radius: 50%; cursor: pointer;
        }
        
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .shop-item {
            border: 2px solid #eee; border-radius: 10px; padding: 10px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center;
        }
        .shop-item:hover { background: #f9f9f9; border-color: #3498db; }
        .shop-item.owned { opacity: 0.5; cursor: default; background: #e0e0e0; }

        .color-picker { display: flex; gap: 10px; justify-content: center; margin: 5px 0 15px; flex-wrap: wrap; }
        .color-swatch { 
            width: 30px; height: 30px; border-radius: 50%; border: 3px solid #eee; 
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
            transition: transform 0.1s;
        }
        .color-swatch.selected { 
            border: 3px solid #000; 
            transform: scale(1.15); 
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        
        h3 { margin: 10px 0 5px; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 5px; }

        #joystick-touch-zone {
            position: absolute; bottom: 30px; left: 30px;
            width: 160px; height: 160px; z-index: 20; border-radius: 50%;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="hud-left">
            <div class="hud-item"><span>üìÖ</span> <span id="clock-display">06:00</span></div>
            <div class="hud-row">
                <div class="hud-item"><span>üéí</span> <span id="inventory-display">Leer</span></div>
                <button id="drop-btn" onclick="dropItem()">‚ùå</button>
            </div>
            <div class="hud-item"><span>‚≠ê</span> <span id="star-display">0</span></div>
            <div id="stamina-container"><div id="stamina-bar"></div></div>
        </div>

        <div id="quest-box">
            <strong>Pferdewunsch:</strong><br>
            <span id="quest-text">...</span>
        </div>
        
        <!-- Context Hints -->
        <div id="groom-hint" class="context-hint">üëã Wischen zum Putzen!</div>
        <div id="garden-hint" class="context-hint">üå± Aktion m√∂glich</div>

        <div class="hud-right">
            <button id="sound-btn" class="icon-btn btn-purple" onclick="toggleSound()">üîä</button>
            <button class="icon-btn btn-orange" onclick="openCustomize()">üé®</button>
            <button class="icon-btn btn-green" onclick="openShop()">üõí</button>
            <button id="train-btn" class="icon-btn btn-teal" style="display:none;" onclick="toggleTrainingMenu()">üéì</button>
            <button class="icon-btn btn-blue" onclick="changeZoom(0.1)">‚ûï</button>
            <button class="icon-btn btn-blue" onclick="changeZoom(-0.1)">‚ûñ</button>
        </div>
        
        <div id="training-actions">
            <button class="train-btn" onclick="commandFoal('rear')">ü¶Ñ Steigen</button>
            <button class="train-btn" onclick="commandFoal('lie')">üí§ Hinlegen</button>
        </div>

        <div id="mobile-actions" style="display:none;">
            <button class="action-circle" onclick="playerJump()">ü¶ò</button>
            <button id="mobile-interact" class="action-circle" onclick="interact()" style="background:#f1c40f; display:none;">üñêÔ∏è</button>
        </div>
    </div>
    
    <div id="sleep-overlay">Gute Nacht! üåô</div>

    <!-- Start / Level Screen -->
    <div id="level-screen">
        <h1 style="color:#FFD700; font-size:40px; margin-bottom:10px;">Pferdehof Deluxe</h1>
        <p>Jahreszeiten, Garten & Fohlen-Training!</p>
        <div id="controls-hint" style="margin:20px 0; color:#ddd;"></div>
        <button onclick="startGame()" style="background:#27ae60; color:white; padding:15px 50px; font-size:24px;">Losreiten</button>
    </div>

    <!-- Shop Modal -->
    <div id="shop-modal">
        <div class="modal-content">
            <div class="modal-close" onclick="closeModals()">√ó</div>
            <h2>Hof-Laden</h2>
            <p>Sterne: <span id="shop-stars">0</span></p>
            <div class="shop-grid" id="shop-grid">
                <!-- Items per JS -->
            </div>
        </div>
    </div>

    <!-- Customize Modal -->
    <div id="customize-modal">
        <div class="modal-content">
            <div class="modal-close" onclick="closeModals()">√ó</div>
            <h2>Ausstattung & Pflege</h2>
            <h3>Fellfarbe</h3><div class="color-picker" id="coat-colors"></div>
            <h3>M√§hnenfarbe</h3><div class="color-picker" id="mane-colors"></div>
            <h3>Satteldecke</h3><div class="color-picker" id="pad-colors"></div>
            <h3>Schweifschleife</h3><div class="color-picker" id="ribbon-colors"></div>
            <button onclick="closeModals()" style="background:#2ecc71; color:white; padding:10px 30px; margin-top:10px;">Fertig</button>
        </div>
    </div>

    <div id="joystick-touch-zone"></div>
    <canvas id="gameCanvas"></canvas>

<script>
    // --- PWA Service Worker ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(e => console.log(e)));
    }

    // --- Audio ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const soundCtx = new AudioContext();
    let soundEnabled = true;

    function toggleSound() {
        soundEnabled = !soundEnabled;
        document.getElementById('sound-btn').innerText = soundEnabled ? "üîä" : "üîá";
        if(soundEnabled && soundCtx.state === 'suspended') soundCtx.resume();
    }
    const Sound = {
        playTone: (f, t, d, v=0.1) => { if(!soundEnabled) return; const o=soundCtx.createOscillator(), g=soundCtx.createGain(); o.type=t; o.frequency.setValueAtTime(f, soundCtx.currentTime); g.gain.setValueAtTime(v, soundCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, soundCtx.currentTime+d); o.connect(g); g.connect(soundCtx.destination); o.start(); o.stop(soundCtx.currentTime+d); },
        playNoise: (d) => { if(!soundEnabled) return; const b=soundCtx.createBuffer(1, soundCtx.sampleRate*d, soundCtx.sampleRate), dt=b.getChannelData(0); for(let i=0;i<b.length;i++) dt[i]=Math.random()*2-1; const n=soundCtx.createBufferSource(); n.buffer=b; const g=soundCtx.createGain(); g.gain.setValueAtTime(0.05, soundCtx.currentTime); const f=soundCtx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=150; n.connect(f); f.connect(g); g.connect(soundCtx.destination); n.start(); },
        playJump: () => Sound.playTone(300, 'sine', 0.3, 0.2),
        playPop: () => Sound.playTone(400, 'triangle', 0.1, 0.1),
        playSuccess: () => { Sound.playTone(523, 'sine', 0.2); setTimeout(()=>Sound.playTone(659, 'sine', 0.4), 100); },
        playCluck: () => { if(!soundEnabled) return; Sound.playTone(450, 'triangle', 0.08, 0.05); setTimeout(()=>Sound.playTone(350, 'triangle', 0.08, 0.05), 80); },
        playSleep: () => { Sound.playTone(300, 'sine', 0.5, 0.1); setTimeout(()=>Sound.playTone(200, 'sine', 0.5, 0.1), 300); },
        playRustle: () => { if(!soundEnabled) return; Sound.playNoise(0.2); },
        playSlide: () => Sound.playTone(600, 'sine', 0.5, 0.02),
        playSplash: () => Sound.playNoise(0.3)
    };

    // --- Game Setup ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.setAttribute('tabindex', '0'); // Canvas fokussierbar machen f√ºr Keyboard

    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    const WORLD_W = 2500, WORLD_H = 2000;

    // Assets
    const itemTypes = {
        apple: { name: "Apfel", emoji: "üçé", color: "#ff4d4d", plantable: true },
        carrot: { name: "M√∂hre", emoji: "ü•ï", color: "#ffa500", plantable: true },
        water: { name: "Wasser", emoji: "üíß", color: "#3498db" },
        brush: { name: "B√ºrste", emoji: "üßπ", color: "#95a5a6" },
        hay: { name: "Heu", emoji: "üåæ", color: "#f1c40f" }
    };
    
    const seasons = [
        { name: "Fr√ºhling", bg: "#7BC043", treeColor: "#2ecc71", riverColor: "#4fc3f7" },
        { name: "Sommer", bg: "#6ab04c", treeColor: "#27ae60", riverColor: "#29b6f6" },
        { name: "Herbst", bg: "#e1b12c", treeColor: "#e67e22", riverColor: "#81d4fa" },
        { name: "Winter", bg: "#dfe6e9", treeColor: "#b2bec3", riverColor: "#b3e5fc" }
    ];

    const shopItems = [
        { id: 'flower_red', name: 'Rote Blumen', cost: 2, type: 'deco', emoji: 'üåπ' },
        { id: 'flower_blue', name: 'Blaue Blumen', cost: 2, type: 'deco', emoji: 'üí†' },
        { id: 'fountain', name: 'Brunnen', cost: 5, type: 'deco', emoji: '‚õ≤' },
        { id: 'bench', name: 'Bank', cost: 3, type: 'deco', emoji: 'ü™ë' }
    ];

    // State
    let gameState = {
        running: false, level: 0, stars: 0,
        time: 0.25, dayDuration: 12000, 
        weather: 'sunny', weatherTimer: 0, seasonIndex: 0,
        entities: { horses: [], items: [], decorations: [], dogs: [], ducks: [], chickens: [], leafPiles: [] },
        terrain: { riverPoints: [], fields: [], trees: [], obstacles: [], fences: [], house: null, beds: [] },
        inventory: null, particles: [], footprints: [],
        camX: 0, camY: 0, zoom: 1.0,
        player: { 
            x: 1250, y: 1000, z: 0, vz: 0, vx: 0, vy: 0, 
            speed: 6, maxStamina: 100, stamina: 100, 
            color: '#654321', maneColor: '#2c2c2c', flip: false, animFrame: 0,
            outfit: { saddlePad: '#ffffff', ribbon: null }
        },
        quest: { horse: null },
        grooming: { active: false, progress: 0, targetHorse: null },
        training: { active: false, targetFoal: null, menuOpen: false },
        sleeping: false,
        purchased: []
    };

    let joy = { active: false, touchId: null, baseX: 110, baseY: 0, stickX: 0, stickY: 0, dx: 0, dy: 0, radius: 50 };
    const keys = { w:false, a:false, s:false, d:false, Shift:false, Space:false };

    // --- Init ---
    function initUI() {
        const hint = document.getElementById('controls-hint');
        const mobActions = document.getElementById('mobile-actions');
        // Lokale Variable, aber sicherstellen, dass sie existiert
        const joystickElement = document.getElementById('joystick-touch-zone');
        
        if (!isTouchDevice) {
            if(joystickElement) joystickElement.style.display = 'none';
            mobActions.style.display = 'none';
            hint.innerHTML = "<b>WASD</b> Bewegen | <b>Shift</b> Sprinten<br><b>Leertaste</b> Springen | <b>Q</b> oder <b>X</b> Ablegen";
        } else {
            mobActions.style.display = 'flex';
            hint.innerHTML = "Joystick zum Bewegen<br>Buttons f√ºr Aktionen";
            
            // Event Listener HIER registrieren, um globale Konflikte zu vermeiden
            if(joystickElement) {
                joystickElement.addEventListener('touchstart', (e) => { 
                    e.preventDefault(); 
                    if (!joy.active) { 
                        const touch = e.changedTouches[0]; 
                        joy.touchId = touch.identifier; 
                        joy.active = true; 
                        updateJoystick(touch); 
                    } 
                }, {passive: false});
                
                joystickElement.addEventListener('touchmove', (e) => { 
                    e.preventDefault(); 
                    if (joy.active) { 
                        for (let i = 0; i < e.changedTouches.length; i++) { 
                            if (e.changedTouches[i].identifier === joy.touchId) { 
                                updateJoystick(e.changedTouches[i]); 
                                break; 
                            } 
                        } 
                    } 
                }, {passive: false});
                
                const endHandler = (e) => { 
                    if (joy.active) { 
                        for (let i = 0; i < e.changedTouches.length; i++) { 
                            if (e.changedTouches[i].identifier === joy.touchId) { 
                                resetJoystick(); 
                                break; 
                            } 
                        } 
                    } 
                };
                joystickElement.addEventListener('touchend', endHandler); 
                joystickElement.addEventListener('touchcancel', endHandler);
            }
        }
        initShop();
    }

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        joy.baseX = 30 + 160/2; joy.baseY = canvas.height - (30 + 160/2);
        if(!joy.active) { joy.stickX = joy.baseX; joy.stickY = joy.baseY; }
    }

    function startGame() {
        document.getElementById('level-screen').style.display = 'none';
        if(soundCtx.state === 'suspended') soundCtx.resume();
        generateWorld();
        gameState.running = true;
        
        // Force focus and start loop
        canvas.focus();
        loop();
    }

    // Ensure canvas keeps focus on click
    document.addEventListener('click', (e) => {
        if(gameState.running && e.target !== document.querySelector('button') && e.target.tagName !== 'INPUT') {
            canvas.focus();
        }
    });

    function generateWorld() {
        gameState.time = 0.25; 
        gameState.stars = 0;
        gameState.entities.horses = [];
        gameState.entities.items = [];
        gameState.entities.leafPiles = [];
        gameState.entities.dogs = [{x: 1300, y: 1050, vx:0, vy:0, flip: false, anim:0, state:'follow', timer: 500, tx:0, ty:0}];
        gameState.entities.ducks = [];
        gameState.entities.chickens = [];
        
        // Terrain
        gameState.terrain.riverPoints = [];
        for(let x=0; x<=WORLD_W; x+=40) gameState.terrain.riverPoints.push({x:x, y: (WORLD_H/2) + Math.sin(x/400)*300});
        
        gameState.terrain.trees = [];
        gameState.terrain.obstacles = [];
        gameState.terrain.fences = [];
        gameState.terrain.beds = [];
        
        // Weltbegrenzung
        for(let x=0; x<=WORLD_W; x+=80) { gameState.terrain.fences.push({x:x, y:5}); gameState.terrain.fences.push({x:x, y:WORLD_H-5}); }
        for(let y=0; y<=WORLD_H; y+=60) { gameState.terrain.fences.push({x:5, y:y}); gameState.terrain.fences.push({x:WORLD_W-5, y:y}); }

        // Haus & Garten
        gameState.terrain.house = {x: 300, y: 300, w: 160, h: 120};
        // 3 Beete neben dem Haus
        for(let i=0; i<3; i++) gameState.terrain.beds.push({x: 500 + i*70, y: 350, w: 60, h: 60, plant: null, growth: 0, watered: false});

        // B√§ume & Hindernisse
        for(let i=0; i<150; i++) {
            let x = Math.random()*WORLD_W, y = Math.random()*WORLD_H;
            if (i >= 80) { if (Math.random() > 0.5) { x = Math.random() < 0.5 ? Math.random() * 100 : WORLD_W - Math.random() * 100; y = Math.random() * WORLD_H; } else { x = Math.random() * WORLD_W; y = Math.random() < 0.5 ? Math.random() * 100 : WORLD_H - Math.random() * 100; } }
            if(!isNearRiver(x,y,80) && !(x > 250 && x < 800 && y > 250 && y < 500)) { // Mehr Platz f√ºrs Haus/Garten
                let apples = [];
                if(Math.random() < 0.3) apples = [{ox:-15,oy:-15}, {ox:15,oy:-5}, {ox:0,oy:-25}, {ox:-10,oy:5}];
                gameState.terrain.trees.push({x:x, y:y, size: 60+Math.random()*40, apples: apples});
            }
        }
        for(let i=0; i<15; i++) {
            let x = Math.random()*WORLD_W, y = Math.random()*WORLD_H;
            if(!isNearRiver(x,y,100) && !(x > 250 && x < 800 && y > 250 && y < 500)) gameState.terrain.obstacles.push({x:x, y:y, w:80, h:20});
        }

        // Tiere
        for(let i=0; i<5; i++) { let pt = gameState.terrain.riverPoints[Math.floor(Math.random()*gameState.terrain.riverPoints.length)]; gameState.entities.ducks.push({x: pt.x, y: pt.y, offset: Math.random()*100}); }
        for(let i=0; i<10; i++) { let cx = 1000 + (Math.random()-0.5)*500; let cy = 1000 + (Math.random()-0.5)*500; gameState.entities.chickens.push({x: cx, y: cy, vx: 0, vy: 0, state: 'idle', timer: 0, panic: 0}); }

        const colors = ['#3e2723', '#795548', '#a1887f', '#d7ccc8', '#eeeeee'];
        for(let i=0; i<6; i++) {
            let px = Math.random()*WORLD_W, py = Math.random()*WORLD_H; px = Math.max(200, Math.min(WORLD_W-200, px)); py = Math.max(200, Math.min(WORLD_H-200, py));
            if(isNearRiver(px,py,100)) continue;
            let horse = { id: i, x: px, y: py, color: colors[i%colors.length], flip: Math.random()>0.5, state: 'idle', timer: 0, tx: px, ty: py, anim: 0, want: Object.values(itemTypes)[Math.floor(Math.random()*5)], satisfied: false };
            gameState.entities.horses.push(horse);
            if(Math.random() > 0.7) gameState.entities.horses.push({ isFoal: true, parent: horse, x: px+20, y: py+20, color: horse.color, flip: horse.flip, anim: 0, trickTimer: 0 });
        }

        const needyHorse = gameState.entities.horses.find(h => !h.isFoal && !h.satisfied);
        if(needyHorse) gameState.quest.horse = needyHorse;
        spawnItems();
        updateSeason(0); // Start Fr√ºhling
        updateUI(); updateQuestUI(); 
    }

    function spawnItems() {
        const spawn = (t, n) => { for(let i=0; i<n; i++) { let x = Math.random()*WORLD_W, y = Math.random()*WORLD_H; if(!isNearRiver(x,y,50)) gameState.entities.items.push({x,y,type:t}); } }
        spawn(itemTypes.water, 5); spawn(itemTypes.carrot, 5); spawn(itemTypes.apple, 5); spawn(itemTypes.hay, 5); spawn(itemTypes.brush, 4);
    }
    
    function updateSeason(idx) {
        gameState.seasonIndex = idx;
        const s = seasons[idx];
        // Herbst Laub
        gameState.entities.leafPiles = [];
        if(s.name === 'Herbst') {
            for(let i=0; i<100; i++) gameState.entities.leafPiles.push({x: Math.random()*WORLD_W, y: Math.random()*WORLD_H});
        }
    }

    // --- Logic Loop ---
    function loop() {
        if(!gameState.running) return;
        
        if(!gameState.sleeping) {
            gameState.time += 1/gameState.dayDuration;
            if(gameState.time >= 1) gameState.time = 0;
            
            gameState.weatherTimer++;
            if(gameState.weatherTimer > 3000) {
                gameState.weatherTimer = 0;
                let nextS = (gameState.seasonIndex + 1) % 4;
                updateSeason(nextS);
                const r = Math.random();
                if(r < 0.6) gameState.weather = 'sunny'; else if(r < 0.9) gameState.weather = 'rain'; else gameState.weather = 'snow';
            }

            handlePlayerMovement();
            updateHorses();
            updateDog();
            updateDucks();
            updateChickens();
            updateGarden();
            checkCollisions();
            checkHouseSleep();
            
            if(seasons[gameState.seasonIndex].name === 'Herbst') {
                const p = gameState.player;
                for(let i=gameState.entities.leafPiles.length-1; i>=0; i--) {
                    let lp = gameState.entities.leafPiles[i];
                    if(Math.hypot(p.x - lp.x, p.y - lp.y) < 30) {
                        Sound.playRustle(); createParticles(lp.x, lp.y, "üçÇ", 3);
                        gameState.entities.leafPiles.splice(i, 1);
                        if(Math.random()>0.5) gameState.entities.leafPiles.push({x: Math.random()*WORLD_W, y: Math.random()*WORLD_H});
                    }
                }
            }
        }

        let tx = gameState.player.x - canvas.width/2;
        let ty = gameState.player.y - canvas.height/2;
        gameState.camX += (tx - gameState.camX) * 0.1;
        gameState.camY += (ty - gameState.camY) * 0.1;

        draw();
        requestAnimationFrame(loop);
    }

    // --- Joystick Logic (Helpers) ---
    function updateJoystick(touch) {
        let dx = touch.clientX - joy.baseX; 
        let dy = touch.clientY - joy.baseY; 
        let dist = Math.hypot(dx, dy);
        
        if(dist > joy.radius) { 
            let ratio = joy.radius / dist; 
            dx *= ratio; 
            dy *= ratio; 
        }
        
        joy.stickX = joy.baseX + dx; 
        joy.stickY = joy.baseY + dy; 
        joy.dx = dx / joy.radius; 
        joy.dy = dy / joy.radius;
    }
    
    function resetJoystick() { 
        joy.active = false; 
        joy.touchId = null; 
        joy.stickX = joy.baseX; 
        joy.stickY = joy.baseY; 
        joy.dx = 0; 
        joy.dy = 0; 
    }

    function handlePlayerMovement() {
        const p = gameState.player;
        let dx = 0, dy = 0;
        
        if(joy.active) { 
            dx = joy.dx; dy = joy.dy; 
        } else { 
            if(keys.w) dy = -1; 
            if(keys.s) dy = 1; 
            if(keys.a) dx = -1; 
            if(keys.d) dx = 1; 
        }

        let speed = p.speed;
        let isWinter = seasons[gameState.seasonIndex].name === 'Winter';
        let onRiver = isNearRiver(p.x, p.y, 60);

        if(onRiver) {
            if(isWinter) {
                p.vx = p.vx * 0.99 + dx * 0.05; 
                p.vy = p.vy * 0.99 + dy * 0.05;
                if(Math.hypot(p.vx, p.vy) > 0.5 && Math.random() < 0.05) Sound.playSlide();
            } else {
                speed *= 0.3;
                if(Math.random() < 0.05 && (dx!=0 || dy!=0)) { Sound.playSplash(); createParticles(p.x, p.y, "üíß", 1); }
            }
        } else {
            p.vx = dx * speed;
            p.vy = dy * speed;
        }

        let isSprinting = (keys.Shift || (joy.active && Math.hypot(joy.dx,joy.dy) > 0.9));
        if(isSprinting && p.stamina > 0 && (dx!=0 || dy!=0)) { 
            if(onRiver && isWinter) { p.vx*=1.02; p.vy*=1.02; } 
            else { p.vx *= 1.6; p.vy *= 1.6; }
            p.stamina -= 0.5; 
        } else { if(p.stamina < p.maxStamina) p.stamina += 0.2; }

        if(p.z > 0 || p.vz !== 0) { p.z += p.vz; p.vz -= 0.8; if(p.z <= 0) { p.z = 0; p.vz = 0; Sound.playNoise(0.1); } }

        p.x += p.vx;
        p.y += p.vy;
        
        if(Math.hypot(p.vx, p.vy) > 0.1) {
            p.animFrame += Math.hypot(p.vx, p.vy) * 0.05;
            p.flip = p.vx < 0;
            if(!onRiver && Math.floor(p.animFrame*10) % 5 === 0 && p.z === 0) gameState.footprints.push({x: p.x, y: p.y, age: 100});
            if(!onRiver && Math.floor(p.animFrame*5) % 10 === 0 && p.z === 0) Sound.playNoise(0.05);
        } else { p.animFrame = 0; }

        p.x = Math.max(50, Math.min(WORLD_W-50, p.x)); p.y = Math.max(50, Math.min(WORLD_H-50, p.y));

        if(p.z < 10) {
            for(let o of gameState.terrain.obstacles) {
                if(p.x > o.x - 20 && p.x < o.x + o.w + 20 && p.y > o.y - 10 && p.y < o.y + o.h + 10) {
                    p.x -= p.vx * 1.5; p.y -= p.vy * 1.5;
                    p.vx = 0; p.vy = 0;
                }
            }
        }
    }

    function playerJump() { if(gameState.player.z === 0) { gameState.player.vz = 12; Sound.playJump(); } }
    
    function interact() {
        if(gameState.training.active) return;
        
        let nearBed = gameState.terrain.beds.find(b => Math.hypot(gameState.player.x - (b.x+b.w/2), gameState.player.y - (b.y+b.h/2)) < 50);
        if(nearBed) { handleGardenInteract(nearBed); return; }

        let nearFoal = gameState.entities.horses.find(h => h.isFoal && Math.hypot(gameState.player.x - h.x, gameState.player.y - h.y) < 60);
        if(nearFoal) { startTraining(nearFoal); return; }

        dropItem();
    }

    function dropItem() {
        if(!gameState.inventory) return;
        if(gameState.grooming.active) return;
        
        let nearBed = gameState.terrain.beds.find(b => Math.hypot(gameState.player.x - (b.x+b.w/2), gameState.player.y - (b.y+b.h/2)) < 50);
        if(nearBed) { handleGardenInteract(nearBed); return; }

        Sound.playPop(); const p = gameState.player;
        let dx = p.flip ? 60 : -60;
        gameState.entities.items.push({ x: p.x + dx, y: p.y, type: gameState.inventory });
        gameState.inventory = null; createParticles(p.x, p.y, "üí®", 5); updateUI();
        if(gameState.quest.horse) updateQuestUI();
    }

    function handleGardenInteract(b) {
        if(!b.plant && gameState.inventory && (gameState.inventory.name === 'Apfel' || gameState.inventory.name === 'M√∂hre')) {
            b.plant = gameState.inventory.name;
            b.growth = 0; b.watered = false;
            Sound.playNoise(0.5); createParticles(b.x+b.w/2, b.y+b.h/2, "üå±", 5);
            gameState.inventory = null; updateUI();
        } else if(b.plant && !b.watered && gameState.inventory && gameState.inventory.name === 'Wasser') {
            b.watered = true;
            Sound.playSplash(); createParticles(b.x+b.w/2, b.y+b.h/2, "üíß", 8);
            gameState.inventory = null; updateUI();
        } else if(b.plant && b.growth >= 100) {
            let type = itemTypes[b.plant === 'Apfel' ? 'apple' : 'carrot'];
            gameState.entities.items.push({ x: b.x+b.w/2, y: b.y+b.h+20, type: type });
            Sound.playPop();
            b.plant = null; b.growth = 0; b.watered = false;
        }
    }

    function updateGarden() {
        gameState.terrain.beds.forEach(b => {
            if(b.plant && b.watered && b.growth < 100) { b.growth += 0.05; }
        });
        
        let nearBed = gameState.terrain.beds.find(b => Math.hypot(gameState.player.x - (b.x+b.w/2), gameState.player.y - (b.y+b.h/2)) < 50);
        const hint = document.getElementById('garden-hint');
        const mobBtn = document.getElementById('mobile-interact');
        
        if(nearBed) {
            hint.style.display = 'block';
            if(isTouchDevice) mobBtn.style.display = 'flex';
            if(!b.plant) hint.innerText = "Pflanzen?";
            else if(!b.watered) hint.innerText = "Gie√üen?";
            else if(b.growth >= 100) hint.innerText = "Ernten!";
            else hint.innerText = "W√§chst...";
        } else {
            hint.style.display = 'none';
        }
        
        let nearFoal = gameState.entities.horses.find(h => h.isFoal && Math.hypot(gameState.player.x - h.x, gameState.player.y - h.y) < 60);
        const trainBtn = document.getElementById('train-btn');
        if(nearFoal) { trainBtn.style.display = 'flex'; if(isTouchDevice) mobBtn.style.display = 'flex'; }
        else { trainBtn.style.display = 'none'; if(!nearBed && isTouchDevice) mobBtn.style.display = 'none'; }
    }

    function toggleTrainingMenu() {
        let nearFoal = gameState.entities.horses.find(h => h.isFoal && Math.hypot(gameState.player.x - h.x, gameState.player.y - h.y) < 60);
        if(nearFoal) startTraining(nearFoal);
    }

    function startTraining(foal) {
        if(gameState.training.active) {
            gameState.training.active = false;
            document.getElementById('training-actions').style.display = 'none';
        } else {
            gameState.training.active = true;
            gameState.training.targetFoal = foal;
            document.getElementById('training-actions').style.display = 'flex';
        }
    }
    
    function commandFoal(cmd) {
        const f = gameState.training.targetFoal;
        if(!f) return;
        
        if(cmd === 'rear') {
            f.trick = 'rear'; f.trickTimer = 60;
            Sound.playJump(); createParticles(f.x, f.y, "‚ú®", 5);
        }
        if(cmd === 'lie') {
            f.trick = 'lie'; f.trickTimer = 100;
            Sound.playNoise(0.2); createParticles(f.x, f.y, "üí§", 5);
        }
        gameState.stars += 1; updateUI();
        gameState.training.active = false;
        document.getElementById('training-actions').style.display = 'none';
    }

    function checkHouseSleep() {
        if(gameState.sleeping) return;
        const p = gameState.player; const h = gameState.terrain.house;
        if(h && p.x > h.x + 60 && p.x < h.x + h.w - 60 && p.y > h.y + h.h - 40 && p.y < h.y + h.h + 20) triggerSleep();
    }
    
    function triggerSleep() {
        gameState.sleeping = true; Sound.playSleep(); document.getElementById('sleep-overlay').style.opacity = 1;
        setTimeout(() => {
            gameState.time = 0.25; gameState.player.stamina = 100; gameState.player.x += 20; 
            updateUI();
            setTimeout(() => { document.getElementById('sleep-overlay').style.opacity = 0; gameState.sleeping = false; }, 1500);
        }, 1500);
    }
    
    function updateHorses() {
        for(let h of gameState.entities.horses) {
            if(h.isFoal) {
                if(h.trickTimer > 0) {
                    h.trickTimer--;
                    if(h.trick === 'rear') h.anim = Math.sin(Date.now()/100)*2; 
                    if(h.trick === 'lie') h.anim = 0; 
                    continue;
                }
                
                let dist = Math.hypot(h.x - h.parent.x, h.y - h.parent.y);
                if(dist > 60) {
                    let angle = Math.atan2(h.parent.y - h.y, h.parent.x - h.x);
                    h.x += Math.cos(angle) * 3; h.y += Math.sin(angle) * 3; h.anim += 0.2; h.flip = Math.cos(angle) < 0;
                } else h.anim = 0;
            } else {
                if(h.state === 'idle') {
                    h.timer++;
                    if(h.timer > 200) { h.state = 'walk'; h.tx = h.x + (Math.random()-0.5)*400; h.ty = h.y + (Math.random()-0.5)*400; h.tx = Math.max(50, Math.min(WORLD_W-50, h.tx)); h.ty = Math.max(50, Math.min(WORLD_H-50, h.ty)); }
                } else if(h.state === 'walk') {
                    let dx = h.tx - h.x, dy = h.ty - h.y; let dist = Math.hypot(dx, dy);
                    if(dist < 5) { h.state = 'idle'; h.timer = 0; h.anim = 0; } else { h.x += (dx/dist)*1.5; h.y += (dy/dist)*1.5; h.flip = dx < 0; h.anim += 0.1; }
                }
            }
        }
    }
    
    function updateDog() { 
        let dog = gameState.entities.dogs[0]; dog.timer--; 
        if(dog.timer <= 0) { 
            let r = Math.random(); 
            if(r < 0.5) { dog.state = 'follow'; dog.timer = 500 + Math.random()*500; } 
            else if (r < 0.8) { dog.state = 'wander'; dog.timer = 300 + Math.random()*300; dog.tx = Math.max(100, Math.min(WORLD_W-100, dog.x + (Math.random()-0.5)*800)); dog.ty = Math.max(100, Math.min(WORLD_H-100, dog.y + (Math.random()-0.5)*800)); } 
            else { dog.state = 'idle'; dog.timer = 200 + Math.random()*200; } 
        } 
        let speed = 4.5; let moving = false; let tx = dog.x, ty = dog.y; 
        if(dog.state === 'follow') { 
            let dist = Math.hypot(dog.x - gameState.player.x, dog.y - gameState.player.y); 
            if(dist > 150) { tx = gameState.player.x; ty = gameState.player.y; moving = true; } 
        } else if (dog.state === 'wander') { 
            let dist = Math.hypot(dog.x - dog.tx, dog.y - dog.ty); 
            if(dist > 10) { tx = dog.tx; ty = dog.ty; moving = true; speed = 2.5; } else { dog.state = 'idle'; dog.timer = 100; } 
        } 
        if(moving) { 
            let angle = Math.atan2(ty - dog.y, tx - dog.x); 
            dog.x += Math.cos(angle) * speed; dog.y += Math.sin(angle) * speed; dog.anim += 0.3; dog.flip = Math.cos(angle) > 0; 
        } else { dog.anim = 0; } 
    }

    function updateChickens() { 
        const p = gameState.player; 
        gameState.entities.chickens.forEach(c => { 
            let dist = Math.hypot(c.x - p.x, c.y - p.y); 
            if (dist < 120) { 
                if (c.panic <= 0) { c.panic = 60; Sound.playCluck(); createParticles(c.x, c.y, "ü™∂", 2); } 
                let angle = Math.atan2(c.y - p.y, c.x - p.x); 
                c.vx = Math.cos(angle) * 5; c.vy = Math.sin(angle) * 5; 
            } else if (c.panic > 0) { 
                c.panic--; c.vx *= 0.95; c.vy *= 0.95; 
            } else { 
                c.timer--; if(c.timer <= 0) { c.timer = 100 + Math.random() * 200; let angle = Math.random() * Math.PI * 2; c.vx = Math.cos(angle) * 0.5; c.vy = Math.sin(angle) * 0.5; } 
            } 
            c.x += c.vx; c.y += c.vy; 
            c.x = Math.max(50, Math.min(WORLD_W-50, c.x)); c.y = Math.max(50, Math.min(WORLD_H-50, c.y)); 
        }); 
    }

    function updateDucks() { for(let d of gameState.entities.ducks) { d.x += Math.sin((Date.now()/1000) + d.offset) * 0.5; } }

    function checkCollisions() {
        const p = gameState.player;
        if(!gameState.inventory) {
            for(let i=0; i<gameState.entities.items.length; i++) {
                let it = gameState.entities.items[i];
                if(Math.hypot(p.x - it.x, p.y - it.y) < 40) {
                    gameState.inventory = it.type; gameState.entities.items.splice(i, 1);
                    Sound.playPop(); createParticles(p.x, p.y, "‚ú®", 8);
                    if(it.type.name === 'Apfel') p.stamina = p.maxStamina;
                    updateUI();
                    const needyHorse = gameState.entities.horses.find(h => !h.isFoal && !h.satisfied);
                    if(needyHorse) { gameState.quest.horse = needyHorse; updateQuestUI(); }
                    break;
                }
            }
        }
        if(gameState.quest.horse && !gameState.quest.horse.satisfied) {
            let h = gameState.quest.horse; let dist = Math.hypot(p.x - h.x, p.y - h.y);
            if(dist < 80) {
                if(h.want.name === 'B√ºrste' && gameState.inventory && gameState.inventory.name === 'B√ºrste') {
                    if(!gameState.grooming.active) { gameState.grooming.active = true; gameState.grooming.targetHorse = h; gameState.grooming.progress = 0; document.getElementById('groom-hint').style.display = 'block'; }
                } else if(gameState.inventory && gameState.inventory.name === h.want.name && !gameState.grooming.active) { completeQuest(h); }
            } else {
                if(gameState.grooming.active) { gameState.grooming.active = false; gameState.grooming.targetHorse = null; document.getElementById('groom-hint').style.display = 'none'; }
            }
        }
    }

    function completeQuest(h) { h.satisfied = true; gameState.inventory = null; gameState.stars += 1; gameState.grooming.active = false; gameState.grooming.targetHorse = null; document.getElementById('groom-hint').style.display = 'none'; Sound.playSuccess(); createParticles(h.x, h.y, "‚ù§Ô∏è", 10); updateUI(); updateQuestUI(); setTimeout(() => { const next = gameState.entities.horses.find(nh => !nh.isFoal && !nh.satisfied); gameState.quest.horse = next || null; updateQuestUI(); }, 2000); }
    let lastMouseX = 0, lastMouseY = 0;
    function handleGroomingInput(x, y) { if(!gameState.grooming.active) return; let delta = Math.hypot(x - lastMouseX, y - lastMouseY); if(delta > 5) { gameState.grooming.progress += delta; if(Math.random() > 0.8) createParticles(gameState.grooming.targetHorse.x, gameState.grooming.targetHorse.y, "‚ú®", 1); if(gameState.grooming.progress > 2000) { completeQuest(gameState.grooming.targetHorse); } } lastMouseX = x; lastMouseY = y; }
    window.addEventListener('mousemove', e => handleGroomingInput(e.clientX, e.clientY));
    window.addEventListener('touchmove', e => handleGroomingInput(e.touches[0].clientX, e.touches[0].clientY));

    // --- Draw ---
    function draw() {
        const H = canvas.height;
        let t = gameState.time; 
        
        const season = seasons[gameState.seasonIndex];
        
        // Hintergrund
        ctx.fillStyle = season.bg;
        ctx.fillRect(0,0,canvas.width, canvas.height);

        // Himmelsfarbe
        let skyOverlay = null; let ambientLight = 0;
        if(t < 0.2) { skyOverlay = ctx.createLinearGradient(0,0,0,H); skyOverlay.addColorStop(0, "rgba(135, 206, 235, 0.4)"); skyOverlay.addColorStop(1, "rgba(241, 196, 15, 0.2)"); } else if(t < 0.7) { skyOverlay = "rgba(135, 206, 235, 0.1)"; } else if(t < 0.8) { skyOverlay = ctx.createLinearGradient(0,0,0,H); skyOverlay.addColorStop(0, "rgba(44, 62, 80, 0.4)"); skyOverlay.addColorStop(1, "rgba(230, 126, 34, 0.3)"); ambientLight = (t-0.7)*5; } else { ambientLight = 0.6; }

        ctx.save();
        ctx.translate(canvas.width/2, canvas.height/2); ctx.scale(gameState.zoom, gameState.zoom);
        ctx.translate(-canvas.width/2, -canvas.height/2); ctx.translate(-gameState.camX, -gameState.camY);

        // Fussspuren
        ctx.fillStyle = "rgba(0,0,0,0.1)"; for(let i=gameState.footprints.length-1; i>=0; i--) { let fp = gameState.footprints[i]; fp.age -= 0.2; if(fp.age <= 0) gameState.footprints.splice(i,1); else { ctx.globalAlpha = fp.age/100 * 0.3; ctx.beginPath(); ctx.ellipse(fp.x, fp.y+45, 10, 5, 0, 0, Math.PI*2); ctx.fill(); } } ctx.globalAlpha = 1;

        // Fluss
        if(gameState.terrain.riverPoints.length>0) {
            ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            ctx.lineWidth = 140; ctx.strokeStyle = "#90A4AE"; 
            ctx.beginPath(); gameState.terrain.riverPoints.forEach((p,i)=>i==0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y)); ctx.stroke();
            
            // Fluss Farbe je nach Saison
            let rCol = season.riverColor;
            if(season.name === 'Winter') rCol = "#e3f2fd"; // Eis
            
            ctx.lineWidth = 120; ctx.strokeStyle = rCol;
            ctx.beginPath(); gameState.terrain.riverPoints.forEach((p,i)=>i==0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y)); ctx.stroke();
            
            if(season.name === 'Winter') {
                // Eis Glanz
                ctx.strokeStyle = "rgba(255,255,255,0.3)"; ctx.lineWidth = 5;
                ctx.beginPath(); 
                gameState.terrain.riverPoints.forEach((p,i) => { if(i%3===0) { ctx.moveTo(p.x-20, p.y-20); ctx.lineTo(p.x+20, p.y+20); } });
                ctx.stroke();
            }
        }
        
        // Gartenbeete
        gameState.terrain.beds.forEach(b => drawGardenBed(ctx, b));

        // Z√§une
        ctx.fillStyle = "#8d6e63"; gameState.terrain.fences.forEach(f => { ctx.beginPath(); ctx.rect(f.x-5, f.y-10, 10, 20); ctx.fill(); });

        // Deko
        gameState.entities.decorations.forEach(d => { ctx.font = "40px Arial"; ctx.fillText(d.emoji, d.x, d.y); });
        
        // Laub
        ctx.font = "20px Arial";
        gameState.entities.leafPiles.forEach(l => { ctx.fillText("üçÇ", l.x, l.y); });
        
        // Enten & H√ºhner
        ctx.globalAlpha = 1.0; ctx.fillStyle = "black"; ctx.font = "30px Arial"; gameState.entities.ducks.forEach(d => ctx.fillText("ü¶Ü", d.x, d.y));

        ctx.fillStyle = "#5d4037";
        gameState.terrain.obstacles.forEach(o => { if(o !== gameState.terrain.obstacles.find(obs => obs.x === gameState.terrain.house.x && obs.y === gameState.terrain.house.y)) { ctx.beginPath(); ctx.roundRect(o.x, o.y, o.w, o.h, 10); ctx.fill(); ctx.fillStyle="rgba(0,0,0,0.2)"; ctx.beginPath(); ctx.roundRect(o.x, o.y+5, o.w, o.h-10, 5); ctx.fill(); ctx.fillStyle="#5d4037"; } });

        ctx.font = "30px Arial"; ctx.textAlign = "center";
        gameState.entities.items.forEach(it => { ctx.fillStyle = "rgba(0,0,0,0.2)"; ctx.beginPath(); ctx.ellipse(it.x, it.y+10, 15, 6, 0, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = "black"; ctx.fillText(it.type.emoji, it.x, it.y + Math.sin(Date.now()/300)*5); });

        const renderList = [
            ...gameState.entities.horses.map(h => ({...h, type:'horse'})),
            ...gameState.entities.dogs.map(d => ({...d, type:'dog'})),
            ...gameState.entities.chickens.map(c => ({...c, type:'chicken'})),
            {...gameState.terrain.house, type: 'house', y: gameState.terrain.house.y + gameState.terrain.house.h},
            {...gameState.player, type:'player'}
        ];
        renderList.sort((a,b) => a.y - b.y);

        renderList.forEach(obj => {
            if(obj.type === 'house') drawHouse(ctx, gameState.terrain.house);
            if(obj.type === 'horse') {
                // Trick Rotation
                let rot = 0; let ty = 0;
                if(obj.trickTimer > 0 && obj.trick === 'rear') { rot = -0.4; ty = -20; }
                if(obj.trickTimer > 0 && obj.trick === 'lie') { rot = Math.PI/2; ty = 30; }
                
                ctx.save();
                if(obj.trick) ctx.translate(obj.x, obj.y);
                if(rot !== 0) ctx.rotate(rot);
                if(obj.trick) ctx.translate(-obj.x, -obj.y + ty);
                
                drawRealisticHorse(ctx, obj.x, obj.y, obj.color, obj.flip, false, obj.anim, obj.state==='walk', 0, obj.isFoal?0.6:1);
                ctx.restore();
                
                if(gameState.quest.horse && obj.id === gameState.quest.horse.id && !obj.satisfied) {
                    ctx.save(); let bounce = Math.sin(Date.now()/200) * 5; ctx.translate(obj.x, obj.y - 80 + bounce); ctx.fillStyle = "white"; ctx.beginPath(); ctx.ellipse(0, 0, 30, 25, 0, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle = "#333"; ctx.lineWidth = 3; ctx.stroke(); ctx.beginPath(); ctx.moveTo(0, 25); ctx.lineTo(-10, 40); ctx.lineTo(10, 25); ctx.fillStyle="white"; ctx.fill(); ctx.stroke(); ctx.font = "30px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillStyle = "black"; ctx.fillText(obj.want.emoji, 0, 0); ctx.fillStyle="white"; ctx.beginPath(); ctx.moveTo(-5,23); ctx.lineTo(5,23); ctx.lineTo(0,30); ctx.fill(); ctx.restore();
                }
                if(gameState.grooming.active && gameState.grooming.targetHorse === obj) { ctx.fillStyle = "rgba(255,255,255,0.5)"; ctx.beginPath(); ctx.arc(obj.x, obj.y, 40, 0, Math.PI*2); ctx.fill(); }
                // Training Marker
                if(gameState.training.active && gameState.training.targetFoal === obj) { ctx.strokeStyle = "#f1c40f"; ctx.lineWidth=3; ctx.setLineDash([5,5]); ctx.beginPath(); ctx.arc(obj.x, obj.y, 30, 0, Math.PI*2); ctx.stroke(); ctx.setLineDash([]); }
            }
            if(obj.type === 'dog') drawDog(ctx, obj);
            if(obj.type === 'chicken') drawChicken(ctx, obj);
            if(obj.type === 'player') drawRealisticHorse(ctx, obj.x, obj.y, obj.color, obj.flip, true, obj.animFrame, (keys.w||keys.a||keys.s||keys.d||joy.active), obj.z, 1);
        });

        gameState.terrain.trees.forEach(t => drawTree(t));

        ctx.font = "20px Arial"; for(let i=gameState.particles.length-1; i>=0; i--) { let p = gameState.particles[i]; p.y -= 1; p.life -= 0.02; ctx.globalAlpha = p.life; ctx.fillText(p.char, p.x, p.y); if(p.life<=0) gameState.particles.splice(i,1); } ctx.globalAlpha = 1; ctx.restore();

        // UI f√ºr Season
        ctx.fillStyle = "white"; ctx.font = "20px Fredoka"; ctx.textAlign = "right"; 
        ctx.fillText(season.name, canvas.width - 20, 100);

        if(skyOverlay) { ctx.fillStyle = skyOverlay; ctx.fillRect(0,0,canvas.width, canvas.height); }
        if(ambientLight > 0) {
            ctx.fillStyle = `rgba(0,0,10,${ambientLight})`; ctx.fillRect(0, 0, canvas.width, canvas.height);
            if(ambientLight > 0.3) {
                let px = (gameState.player.x - gameState.camX) * gameState.zoom + canvas.width/2; let py = (gameState.player.y - gameState.camY) * gameState.zoom + canvas.height/2;
                const g = ctx.createRadialGradient(px, py, 20*gameState.zoom, px, py, 150*gameState.zoom); g.addColorStop(0, "rgba(255, 200, 100, 0.3)"); g.addColorStop(1, "rgba(0,0,0,0)");
                ctx.save(); ctx.globalCompositeOperation = 'lighter'; ctx.fillStyle = g; ctx.beginPath(); ctx.arc(px, py, 150*gameState.zoom, 0, Math.PI*2); ctx.fill();
                if(gameState.terrain.house) { let hx = (gameState.terrain.house.x + gameState.terrain.house.w/2 - gameState.camX) * gameState.zoom + canvas.width/2; let hy = (gameState.terrain.house.y + gameState.terrain.house.h/2 - gameState.camY) * gameState.zoom + canvas.height/2; const gh = ctx.createRadialGradient(hx, hy, 10*gameState.zoom, hx, hy, 60*gameState.zoom); gh.addColorStop(0, "rgba(255, 255, 200, 0.5)"); gh.addColorStop(1, "rgba(0,0,0,0)"); ctx.fillStyle = gh; ctx.beginPath(); ctx.arc(hx, hy, 60*gameState.zoom, 0, Math.PI*2); ctx.fill(); }
                ctx.restore();
            }
        }

        if(gameState.weather !== 'sunny') {
            ctx.strokeStyle = (gameState.weather === 'rain') ? "rgba(100,150,255,0.5)" : "rgba(255,255,255,0.8)"; ctx.lineWidth = (gameState.weather === 'rain') ? 2 : 4; ctx.beginPath();
            for(let i=0; i<100; i++) { let px = (Date.now()/5 + i*157) % canvas.width; let py = (Date.now()/2 + i*313) % canvas.height; if(gameState.weather === 'rain') { ctx.moveTo(px, py); ctx.lineTo(px-5, py+10); } else { ctx.moveTo(px, py); ctx.lineTo(px+2, py+2); } } ctx.stroke();
        }
        
        if(isTouchDevice) drawJoystick();
    }
    
    function drawGardenBed(ctx, b) {
        // Erde
        ctx.fillStyle = b.watered ? "#5d4037" : "#8d6e63"; // Dunkler wenn nass
        ctx.fillRect(b.x, b.y, b.w, b.h);
        ctx.strokeStyle = "#4e342e"; ctx.lineWidth=2; ctx.strokeRect(b.x, b.y, b.w, b.h);
        
        if(b.plant) {
            let emoji = "üå±";
            if(b.growth > 30) emoji = "üåø";
            if(b.growth >= 100) emoji = b.plant === 'Apfel' ? "üçé" : "ü•ï";
            
            ctx.font = "30px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(emoji, b.x + b.w/2, b.y + b.h/2);
            
            // Progress Bar
            if(b.growth < 100) {
                ctx.fillStyle = "rgba(255,255,255,0.5)"; ctx.fillRect(b.x+5, b.y+b.h-10, b.w-10, 5);
                ctx.fillStyle = "#2ecc71"; ctx.fillRect(b.x+5, b.y+b.h-10, (b.w-10)*(b.growth/100), 5);
            }
        }
    }
    
    function drawJoystick() { ctx.beginPath(); ctx.arc(joy.baseX, joy.baseY, joy.radius, 0, Math.PI*2); ctx.fillStyle = "rgba(255,255,255,0.2)"; ctx.strokeStyle = "rgba(255,255,255,0.5)"; ctx.lineWidth = 4; ctx.fill(); ctx.stroke(); let x = joy.active ? joy.stickX : joy.baseX; let y = joy.active ? joy.stickY : joy.baseY; ctx.beginPath(); ctx.arc(x, y, 25, 0, Math.PI*2); ctx.fillStyle = "white"; ctx.fill(); }
    function drawHouse(ctx, h) { ctx.fillStyle = "rgba(0,0,0,0.2)"; ctx.fillRect(h.x+5, h.y+h.h-5, h.w, 10); ctx.fillStyle = "#ecf0f1"; ctx.fillRect(h.x, h.y, h.w, h.h); ctx.fillStyle = "#5d4037"; ctx.fillRect(h.x, h.y, 10, h.h); ctx.fillRect(h.x+h.w-10, h.y, 10, h.h); ctx.fillRect(h.x, h.y, h.w, 10); ctx.fillRect(h.x, h.y+h.h-10, h.w, 10); ctx.beginPath(); ctx.moveTo(h.x, h.y); ctx.lineTo(h.x+h.w, h.y+h.h); ctx.strokeStyle="#5d4037"; ctx.lineWidth=5; ctx.stroke(); ctx.beginPath(); ctx.moveTo(h.x+h.w, h.y); ctx.lineTo(h.x, h.y+h.h); ctx.stroke(); ctx.fillStyle = "#c0392b"; ctx.beginPath(); ctx.moveTo(h.x-10, h.y); ctx.lineTo(h.x + h.w/2, h.y - 60); ctx.lineTo(h.x + h.w + 10, h.y); ctx.fill(); ctx.fillStyle = "#3e2723"; ctx.fillRect(h.x + h.w/2 - 15, h.y + h.h - 40, 30, 40); ctx.fillStyle = "#8d6e63"; ctx.fillRect(h.x + h.w/2 - 30, h.y - 20, 60, 20); ctx.fillStyle = "#fff"; ctx.font = "12px Fredoka"; ctx.textAlign = "center"; ctx.fillText("Gute Nacht", h.x + h.w/2, h.y - 6); }
    function drawChicken(ctx, c) { ctx.save(); ctx.translate(c.x, c.y); if(c.vx < 0) ctx.scale(-1, 1); let bounce = c.panic > 0 ? Math.sin(Date.now()/50)*5 : Math.abs(Math.sin(Date.now()/200))*2; ctx.translate(0, -bounce); ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.ellipse(0, 0, 10, 8, 0, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.moveTo(-8, -2); ctx.lineTo(-12, -8); ctx.lineTo(-10, -2); ctx.fill(); ctx.beginPath(); ctx.arc(6, -6, 5, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = "#e74c3c"; ctx.beginPath(); ctx.ellipse(6, -10, 3, 2, 0, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.ellipse(8, -4, 2, 3, 0, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = "#f39c12"; ctx.beginPath(); ctx.moveTo(9, -7); ctx.lineTo(13, -5); ctx.lineTo(9, -3); ctx.fill(); ctx.fillStyle = "#000"; ctx.beginPath(); ctx.arc(7, -7, 1, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle = "#ddd"; ctx.lineWidth = 1; ctx.beginPath(); ctx.arc(0, 0, 5, 0, Math.PI, false); ctx.stroke(); ctx.restore(); }
    function drawDog(ctx, d) { ctx.save(); ctx.translate(d.x, d.y); if(d.flip) ctx.scale(-1, 1); let l = Math.sin(d.anim)*4; let headBob = Math.abs(Math.sin(d.anim*2))*2; let tailWag = Math.sin(d.anim*3)*0.5; ctx.strokeStyle = "#e5e5e5"; ctx.lineWidth = 5; ctx.lineCap = "round"; ctx.beginPath(); ctx.moveTo(5, 5); ctx.lineTo(5-l, 20); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-10, 5); ctx.lineTo(-10+l, 20); ctx.stroke(); ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.ellipse(0, 5, 14, 8, 0, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = "#8d6e63"; ctx.beginPath(); ctx.arc(-5, 2, 4, 0, Math.PI*2); ctx.fill(); ctx.save(); ctx.translate(12, 0); ctx.rotate(-0.5 + tailWag); ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.ellipse(0, -6, 2, 6, 0, 0, Math.PI*2); ctx.fill(); ctx.restore(); ctx.strokeStyle = "red"; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(-8, 5); ctx.lineTo(-8, -5); ctx.stroke(); ctx.strokeStyle = "#fff"; ctx.lineWidth = 5; ctx.beginPath(); ctx.moveTo(5, 5); ctx.lineTo(5+l, 20); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-10, 5); ctx.lineTo(-10-l, 20); ctx.stroke(); ctx.save(); ctx.translate(-12, -8 + headBob); ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(0, 0, 9, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = "#8d6e63"; ctx.beginPath(); ctx.ellipse(-2, -6, 3, 6, -0.5, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.ellipse(6, -4, 3, 6, 0.5, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = "#8d6e63"; ctx.beginPath(); ctx.arc(-3, -2, 4, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(-8, 1, 2, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(-3, -2, 1.5, 0, Math.PI*2); ctx.fill(); ctx.restore(); ctx.restore(); }
    function drawTree(t) { let color = seasons[gameState.seasonIndex].treeColor; if(gameState.weather==='snow') color = "#bdc3c7"; else if(gameState.weather==='rain') color = "#1e8449"; ctx.fillStyle = "#795548"; ctx.beginPath(); ctx.rect(t.x-8, t.y, 16, 20); ctx.fill(); ctx.fillStyle = color; ctx.beginPath(); ctx.arc(t.x, t.y-30, t.size/2, 0, Math.PI*2); ctx.fill(); if(gameState.weather !== 'snow' && t.apples && t.apples.length > 0) { ctx.fillStyle = "#c0392b"; t.apples.forEach(a => { ctx.beginPath(); ctx.arc(t.x+a.ox, t.y-30+a.oy, 5, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = "rgba(255,255,255,0.4)"; ctx.beginPath(); ctx.arc(t.x+a.ox-1, t.y-30+a.oy-1, 2, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = "#c0392b"; }); } }
    function drawRealisticHorse(ctx, x, y, color, flip, isPlayer, animFrame, isMoving, z=0, scale=1) { ctx.save(); ctx.translate(x, y - z); ctx.scale(scale, scale); if(flip) ctx.scale(-1, 1); let hop = isMoving ? Math.sin(animFrame)*3 : 0; let rl = isMoving ? Math.sin(animFrame) : 0; let fl = isMoving ? Math.sin(animFrame+Math.PI) : 0; let hb = isMoving ? Math.sin(animFrame*1.5)*2 : Math.sin(Date.now()/600)*2; ctx.translate(0, hop); if(z < 50) { ctx.fillStyle = `rgba(0,0,0,${0.2 - z/200})`; ctx.beginPath(); ctx.ellipse(0, 50-hop+z, 25, 6, 0, 0, Math.PI*2); ctx.fill(); } ctx.fillStyle = color; ctx.strokeStyle = color; ctx.lineJoin = "round"; ctx.lineCap = "round"; ctx.lineWidth = 8; ctx.beginPath(); ctx.moveTo(-20, 10); ctx.quadraticCurveTo(-25+rl*10, 25, -22+rl*15, 35); ctx.lineTo(-22+rl*18, 50); ctx.stroke(); ctx.fillStyle = "#1a1a1a"; ctx.beginPath(); ctx.fillRect(-24+rl*18, 50, 6, 4); ctx.fill(); ctx.strokeStyle = color; ctx.beginPath(); ctx.moveTo(20, 10); ctx.quadraticCurveTo(25+fl*10, 25, 22+fl*12, 35); ctx.lineTo(22+fl*15, 50); ctx.stroke(); ctx.fillStyle = "#1a1a1a"; ctx.beginPath(); ctx.fillRect(20+fl*15, 50, 6, 4); ctx.fill(); ctx.fillStyle = color; ctx.beginPath(); ctx.moveTo(25, 5); ctx.bezierCurveTo(30, 20, 10, 25, -10, 22); ctx.bezierCurveTo(-30, 20, -35, 5, -25, -5); ctx.bezierCurveTo(-15, -10, 10, -10, 25, 5); ctx.fill(); if(isPlayer && gameState.player.outfit.saddlePad) { ctx.fillStyle = gameState.player.outfit.saddlePad; ctx.beginPath(); ctx.moveTo(5, -5); ctx.lineTo(15, 10); ctx.lineTo(-10, 12); ctx.lineTo(-15, -5); ctx.fill(); } let rl2 = isMoving ? Math.sin(animFrame+Math.PI) : 0; ctx.strokeStyle = color; ctx.beginPath(); ctx.moveTo(-15, 10); ctx.quadraticCurveTo(-20+rl2*10, 25, -17+rl2*15, 35); ctx.lineTo(-17+rl2*18, 52); ctx.stroke(); ctx.fillStyle = "#1a1a1a"; ctx.beginPath(); ctx.fillRect(-19+rl2*18, 52, 6, 4); ctx.fill(); let fl2 = isMoving ? Math.sin(animFrame) : 0; ctx.strokeStyle = color; ctx.beginPath(); ctx.moveTo(15, 10); ctx.quadraticCurveTo(20+fl2*10, 25, 17+fl2*12, 35); ctx.lineTo(17+fl2*15, 52); ctx.stroke(); ctx.fillStyle = "#1a1a1a"; ctx.beginPath(); ctx.fillRect(15+fl2*15, 52, 6, 4); ctx.fill(); ctx.save(); ctx.translate(16, -6+hb); ctx.rotate(-0.2); ctx.fillStyle = color; ctx.beginPath(); ctx.moveTo(-10, 15); ctx.lineTo(0, -25); ctx.lineTo(10, -20); ctx.lineTo(12, 15); ctx.fill(); ctx.beginPath(); ctx.arc(6, -25, 9, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.ellipse(13, -22, 12, 7, 0.2, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = isPlayer ? gameState.player.maneColor : "#2c2c2c"; ctx.beginPath(); ctx.moveTo(-4,-35); ctx.quadraticCurveTo(-15,-25,-10,0); ctx.lineTo(0,-25); ctx.fill(); ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(6,-27,3.5,0,Math.PI*2); ctx.fill(); ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(7,-27,1.5,0,Math.PI*2); ctx.fill(); ctx.restore(); ctx.strokeStyle = isPlayer ? gameState.player.maneColor : "#2c2c2c"; ctx.lineWidth = 6; ctx.beginPath(); ctx.moveTo(-28, 0); let tw = isMoving ? Math.sin(animFrame*2)*5 : Math.sin(Date.now()/300)*3; ctx.quadraticCurveTo(-45, 10, -40+tw, 35); ctx.stroke(); if(isPlayer && gameState.player.outfit.ribbon) { ctx.save(); ctx.translate(-28, 0); ctx.fillStyle = gameState.player.outfit.ribbon; ctx.beginPath(); ctx.arc(0,0, 3, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.ellipse(0, 3, 5, 2, Math.PI/4, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.ellipse(0, 3, 5, 2, -Math.PI/4, 0, Math.PI*2); ctx.fill(); ctx.restore(); } if(isPlayer) { ctx.fillStyle = "#c0392b"; ctx.beginPath(); ctx.moveTo(5, -5); ctx.quadraticCurveTo(0, 0, -15, -5); ctx.quadraticCurveTo(-10, 10, 5, 10); ctx.fill(); } ctx.restore(); }
    
    function changeZoom(d) { gameState.zoom = Math.max(0.5, Math.min(2.0, gameState.zoom + d)); }
    function createParticles(x, y, char, count) { for(let i=0; i<count; i++) gameState.particles.push({x:x+(Math.random()-0.5)*40, y:y, char:char, life:1.0}); }
    function isNearRiver(x, y, dist) { for(let p of gameState.terrain.riverPoints) { if(Math.hypot(x - p.x, y - p.y) < dist) return true; } return false; }
    
    function updateUI() { document.getElementById('inventory-display').innerText = gameState.inventory ? gameState.inventory.name : "Nichts"; document.getElementById('star-display').innerText = gameState.stars; document.getElementById('drop-btn').style.display = gameState.inventory ? "block" : "none"; let h = Math.floor(gameState.time * 24); let m = Math.floor((gameState.time * 24 * 60) % 60); document.getElementById('clock-display').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; document.getElementById('stamina-bar').style.width = gameState.player.stamina + '%'; }
    function updateQuestUI() { const h = gameState.quest.horse; const box = document.getElementById('quest-box'); const text = document.getElementById('quest-text'); if(!h) { text.innerText = "Alle zufrieden!"; box.style.borderLeftColor = "#ccc"; box.style.display = 'block'; setTimeout(() => { if(!gameState.quest.horse) box.style.display = 'none'; }, 3000); return; } box.style.display = 'block'; if(gameState.inventory && gameState.inventory.name === h.want.name) { text.innerHTML = `Gib <b>${h.want.name}</b> ab!`; box.style.borderLeftColor = "#2ecc71"; } else { text.innerHTML = `Ein Pferd m√∂chte:<br><b>${h.want.name}</b> ${h.want.emoji}`; box.style.borderLeftColor = "#FFD700"; } }

    function initShop() { const grid = document.getElementById('shop-grid'); grid.innerHTML = ""; shopItems.forEach(item => { let div = document.createElement('div'); div.className = 'shop-item'; div.innerHTML = `<span style="font-size:30px">${item.emoji}</span><b>${item.name}</b><span>‚≠ê ${item.cost}</span>`; div.onclick = () => buyItem(item); grid.appendChild(div); }); }
    function buyItem(item) { if(gameState.stars >= item.cost) { gameState.stars -= item.cost; Sound.playSuccess(); gameState.entities.decorations.push({ x: gameState.player.x + (Math.random()-0.5)*100, y: gameState.player.y + (Math.random()-0.5)*100, emoji: item.emoji }); updateUI(); closeModals(); } else { alert("Nicht genug Sterne!"); } }
    
    function initCustomize() { updateCustomizeUI(); }
    function updateCustomizeUI() { const colors = ['#654321', '#212121', '#eeeeee', '#d7ccc8', '#a1887f']; const manes = ['#2c2c2c', '#eeeeee', '#8B4513']; const padColors = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6', '#ffffff']; const ribbonColors = [null, '#e74c3c', '#3498db', '#f1c40f', '#ff69b4']; const createSwatches = (containerId, list, currentVal, setter) => { const container = document.getElementById(containerId); container.innerHTML = ''; list.forEach(c => { let d = document.createElement('div'); d.className = 'color-swatch' + (currentVal === c ? ' selected' : ''); if(c === null) { d.style.background = '#ccc'; d.innerText = "‚ùå"; d.style.display="flex"; d.style.alignItems="center"; d.style.justifyContent="center"; } else d.style.background = c; d.onclick = () => { setter(c); Sound.playPop(); updateCustomizeUI(); }; container.appendChild(d); }); }; createSwatches('coat-colors', colors, gameState.player.color, (c) => gameState.player.color = c); createSwatches('mane-colors', manes, gameState.player.maneColor, (c) => gameState.player.maneColor = c); createSwatches('pad-colors', padColors, gameState.player.outfit.saddlePad, (c) => gameState.player.outfit.saddlePad = c); createSwatches('ribbon-colors', ribbonColors, gameState.player.outfit.ribbon, (c) => gameState.player.outfit.ribbon = c); }
    function openShop() { document.getElementById('shop-stars').innerText = gameState.stars; document.getElementById('shop-modal').style.display = 'flex'; }
    function openCustomize() { updateCustomizeUI(); document.getElementById('customize-modal').style.display = 'flex'; }
    function closeModals() { document.getElementById('shop-modal').style.display = 'none'; document.getElementById('customize-modal').style.display = 'none'; }

    // Reset keys on window blur to prevent stuck keys
    window.addEventListener('blur', () => { 
        keys.w = false; keys.a = false; keys.s = false; keys.d = false; keys.Shift = false; keys.Space = false;
    });

    window.addEventListener('keydown', e => { 
        // Prevent default scrolling for game keys
        if(["Space", "ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.code)) e.preventDefault();
        
        if(e.code === 'KeyW' || e.code === 'ArrowUp') keys.w = true; 
        if(e.code === 'KeyS' || e.code === 'ArrowDown') keys.s = true; 
        if(e.code === 'KeyA' || e.code === 'ArrowLeft') keys.a = true; 
        if(e.code === 'KeyD' || e.code === 'ArrowRight') keys.d = true; 
        if(e.key === 'Shift') keys.Shift = true; 
        if(e.code === 'Space') { keys.Space = true; playerJump(); } 
        if(e.code === 'KeyQ' || e.code === 'KeyX') interact(); 
    });
    
    window.addEventListener('keyup', e => { 
        if(e.code === 'KeyW' || e.code === 'ArrowUp') keys.w = false; 
        if(e.code === 'KeyS' || e.code === 'ArrowDown') keys.s = false; 
        if(e.code === 'KeyA' || e.code === 'ArrowLeft') keys.a = false; 
        if(e.code === 'KeyD' || e.code === 'ArrowRight') keys.d = false; 
        if(e.key === 'Shift') keys.Shift = false; 
        if(e.code === 'Space') keys.Space = false; 
    });
    
    window.addEventListener('resize', resize);
    resize();
    initUI();
    
    // Debugging
    console.log("Pferdehof Deluxe v1.2 loaded - Controls active");
</script>
</body>
</html>